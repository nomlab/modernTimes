[English][] | [日本語][]


[English]:  https://github.com/nomlab/modernTimes/blob/main/README.md       "English"
[日本語]:    https://github.com/nomlab/modernTimes/blob/main/README.ja.md    "日本語"

# modernTimes
modernTimes is a tool to assist nurses in creating schedules.
The system has two methods for creating schedules.
1. automatic generation by block programming
2. manual generation by inputting and editing the schedule table

In method 1, an AUK is generated by describing constraints with visual blocks using google Blockly, and the schedule is created using the AUK.
AUK is a DSL (Domain Specific Language) that can describe nurse scheduling problems.

The system is based on AUK and can generate AUK not only from visual blocks but also from schedules.
Therefore, the system enables interactive schedule creation by editing the AUK representing the schedule (adding constraints using blocks) and then solving the schedule again.
The system uses an extension of [Swallow](https://github.com/matsuda0528/swallow) for the schedule solver.
Swallow uses SAT solvers for schedule solving.
An interface to SAT Solver is provided by [Ravensat](https://github.com/ueno12345/ravensat/).

# Requirements
+ Ruby 3.1.2
+ ruby on rails 7~

# Setup
## modernTimes
1. Download modernTimes
   ```bash
   $ git clone https://github.com/nomlab/modernTimes.git
   ```

## SAT solver install
1. Install Minisat
   ```bash
    $ sudo apt install minisat
   ```

# Launch
## Preparation
1. Execute `bundle install`
   ```bash
   $ bundle install
   ```
2. Execute `npm install`
   ```bash
   $ npm install
   ```
3. Remove Existing Credentials (Optional)

   If a shared credentials.yml.enc and master.key exist, you may need to remove them first.
   ```bash
      $ rm config/credentials.yml.enc
   ```
4. Generate a New master.key

   Each user can generate their own `master.key` using the following command:
   `bin/rails credentials:edit`
   This will create a new `master.key` in the `config/` directory. A new `credentials.yml.enc` file will also be generated if it does not exist. When the editor opens, you can add the required settings (e.g., `secret_key_base`).
5. Add Required Settings to credentials.yml.enc

   Redirect the output of `rails secret` directly into the credentials editor to simplify the process:
   ```bash
   $ EDITOR="echo secret_key_base: $(rails secret) >>" bin/rails credentials:edit
   ```
6. Create a DB
   ```bash
   $ bundle exec rails db:migrate RAILS_ENV=production
   ```

## Linux
1. Launch<br >
   To run the following, you need to pass `bin/modernTimes`.
+ Start the system.<br >
   `$ modernTimes start production`.
+ Restart the system.<br >
   `$ modernTimes restart production`
+ Stop the system.<br >
   `$ modernTimes stop`
   After launching, open http://localhost:54321 in your browser to open the modernTimes screen


# Install for developpers
1. Download modenTimes
   ```bash
   $ git clone https://github.com/nomlab/modernTimes.git
   ```
2. Install Minisat
   ```bash
    $ sudo apt install minisat
   ```
3. Execute `bundle install`
   ```bash
   $ bundle install
   ```
4. Execute `npm install`
   ```bash
   $ npm install
   ```
5. Create a DB
   ```bash
   $ bundle exec rails db:migrate RAILS_ENV=development
   ```
6. Create a dummy data
   ```
   $ bin/rails runner scripts/create_dummy_data.rb
   ```
7. Launch<br >
   To run the following, you need to pass `bin/modernTimes`.
+ Start the system.<br >
   `$ modernTimes start development`.
+ Restart the system.<br >
   `$ modernTimes restart development`.
+ Stop the system.<br >
   `$ modernTimes stop`

   After launching, open http://localhost:3000 in your browser to open the modernTimes screen

# ER diagram
```mermaid
%%{init:{'theme':'base','themeVariables':{'primaryColor':'#ffffff','primaryTextColor':'#ffffff','primaryBorderColor':'#000000','secondaryColor':'#000000','lineColor':'#000000','noteTextColor':'#000000','noteBkgColor':'#000000','textColor':'#000000','fontSize':'20px','fontFamily':''},'themeCSS':"text.actor {font-size:24px !important;}"}}%%
 erDiagram
   rails_nurses }|--|| teams : "many to one"
   rails_nurses ||--|{ assignments : "one to many"
   assignments }|--|| shift_types : "many to one"
   rails_nurses {
     integer id PK
     string name "name"
     integer ladder_level "1-5: the more experienced, the bigger"
     references team_id FK
   }

   teams {
     integer id PK
     string name "team name"
   }

   assignments {
     integer id PK
     date date "date"
     references rails_nurse_id FK
     references shift_type_id FK
     integer state "number of states such as fixed, unfixed, requested, etc"
   }

   shift_types {
     integer id PK
     string name "Shift type (day, semi-night, night, rest, etc)"
     integer kind "Type of how the value is handled"
   }
 ```
